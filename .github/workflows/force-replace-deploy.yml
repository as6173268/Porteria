name: ğŸš€ Force Replace Deploy to Porteria

on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "CONFIRM" to proceed with DESTRUCTIVE deployment'
        required: true
        default: ''
  push:
    branches: [ main ]
    paths: [ 'src/**', 'public/**', 'package.json', 'vite.config.ts' ]

env:
  TARGET_REPO: albertomaydayjhondoe/Porteria
  SOURCE_BUILD_DIR: dist

permissions:
  contents: read

jobs:
  force-replace-deploy:
    name: ğŸ”¥ Force Replace Porteria Repository
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›¡ï¸ Validate Deployment Confirmation
      if: github.event_name == 'workflow_dispatch'
      run: |
        if [ "${{ github.event.inputs.confirm_deployment }}" != "CONFIRM" ]; then
          echo "âŒ Deployment cancelled: Confirmation required"
          echo "â„¹ï¸  Please type 'CONFIRM' in the input field to proceed"
          exit 1
        fi
        echo "âœ… Deployment confirmed by user input"

    - name: âš ï¸ Deployment Warning
      run: |
        echo "ğŸš¨ WARNING: This workflow will DESTRUCTIVELY replace ALL content in:"
        echo "   Repository: ${{ env.TARGET_REPO }}"
        echo "   Branch: main"
        echo ""
        echo "ğŸ“‹ Actions to be performed:"
        echo "   1. Create backup branch with timestamp"
        echo "   2. DELETE all existing content (except .git)"
        echo "   3. Replace with build artifacts from this repository"
        echo "   4. Force push to overwrite main branch"
        echo ""
        echo "ğŸ”’ Backup will be created: backup-before-force-deploy-$(date -u +%Y%m%dT%H%M%SZ)"

    - name: ğŸ” Checkout Source Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: source

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: source/package-lock.json

    - name: ğŸ—ï¸ Install Dependencies and Build
      run: |
        cd source
        npm ci
        npm run build
        echo "âœ… Build completed successfully"
        
        # Verify build directory exists and has content
        if [ ! -d "${{ env.SOURCE_BUILD_DIR }}" ]; then
          echo "âŒ Build directory '${{ env.SOURCE_BUILD_DIR }}' not found"
          exit 1
        fi
        
        file_count=$(find ${{ env.SOURCE_BUILD_DIR }} -type f | wc -l)
        if [ "$file_count" -eq 0 ]; then
          echo "âŒ Build directory is empty"
          exit 1
        fi
        
        echo "ğŸ“Š Build artifacts: $file_count files generated"
        ls -la ${{ env.SOURCE_BUILD_DIR }}/

    - name: ğŸ¯ Checkout Target Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ env.TARGET_REPO }}
        token: ${{ secrets.TARGET_REPO_PAT }}
        fetch-depth: 0
        path: porteria

    - name: ğŸ”§ Configure Git for Target Repository
      run: |
        cd porteria
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        echo "âœ… Git configuration set"

    - name: ğŸ’¾ Create Backup Branch
      run: |
        cd porteria
        backup_branch="backup-before-force-deploy-$(date -u +%Y%m%dT%H%M%SZ)"
        echo "ğŸ“‹ Creating backup branch: $backup_branch"
        
        git checkout main
        git checkout -b "$backup_branch"
        git push origin "$backup_branch"
        
        echo "âœ… Backup branch created and pushed: $backup_branch"
        echo "ğŸ”— Backup available at: https://github.com/${{ env.TARGET_REPO }}/tree/$backup_branch"

    - name: ğŸ—‘ï¸ Clear Target Repository Content
      run: |
        cd porteria
        git checkout main
        
        echo "ğŸ§¹ Removing all content except .git directory..."
        find . -maxdepth 1 \
          ! -name '.git' \
          ! -name '.' \
          ! -name '..' \
          -exec rm -rf {} \; 2>/dev/null || true
        
        echo "âœ… Target repository cleared"

    - name: ğŸ“‹ Copy Build Artifacts
      run: |
        echo "ğŸ“¦ Copying build artifacts from source to target..."
        cp -r source/${{ env.SOURCE_BUILD_DIR }}/* porteria/
        
        # Remove node_modules if accidentally copied
        if [ -d "porteria/node_modules" ]; then
          rm -rf porteria/node_modules
          echo "ğŸ§¹ Removed node_modules directory"
        fi
        
        cd porteria
        file_count=$(find . -maxdepth 1 -type f | wc -l)
        echo "ğŸ“Š Files copied to target: $file_count"
        ls -la

    - name: ğŸ“ Commit and Force Push Changes
      run: |
        cd porteria
        
        # Check if there are changes to commit
        if git diff --quiet && git diff --cached --quiet; then
          echo "â„¹ï¸  No changes detected, skipping commit"
          exit 0
        fi
        
        git add .
        git status
        
        commit_message="ğŸš€ Force deploy Daily Paper Comics - $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)

        ğŸ”„ Automated deployment from daily-paper-comics repository
        ğŸ“¦ Source commit: ${{ github.sha }}
        ğŸ—ï¸ Build artifacts deployed to GitHub Pages
        
        âš ï¸  This commit REPLACES all previous content
        ğŸ’¾ Previous content backed up in: backup-before-force-deploy-$(date -u +%Y%m%dT%H%M%SZ)"
        
        git commit -m "$commit_message"
        
        echo "ğŸš€ Force pushing to main branch..."
        git push --force origin HEAD:main
        
        echo "âœ… Deployment completed successfully!"
        echo "ğŸŒ GitHub Pages will be available at: https://albertomaydayjhondoe.github.io/Porteria/"

    - name: ğŸ“Š Deployment Summary
      if: success()
      run: |
        echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
        echo ""
        echo "ğŸ“‹ Summary:"
        echo "   âœ… Source repository: daily-paper-comics"
        echo "   âœ… Target repository: ${{ env.TARGET_REPO }}"
        echo "   âœ… Build artifacts deployed"
        echo "   âœ… Backup branch created"
        echo "   âœ… Main branch force updated"
        echo ""
        echo "ğŸŒ Live URL: https://albertomaydayjhondoe.github.io/Porteria/"
        echo "ğŸ’¾ Backup: https://github.com/${{ env.TARGET_REPO }}/branches"

    - name: âŒ Deployment Failure Notification
      if: failure()
      run: |
        echo "ğŸ’¥ DEPLOYMENT FAILED!"
        echo ""
        echo "ğŸ” Troubleshooting checklist:"
        echo "   - Verify TARGET_REPO_PAT secret is configured"
        echo "   - Ensure PAT has 'repo' scope permissions"
        echo "   - Check target repository exists and is accessible"
        echo "   - Verify build process completed successfully"
        echo ""
        echo "ğŸ“š See README_DEPLOY.md for detailed setup instructions"